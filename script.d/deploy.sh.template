#!/bin/bash
# ==========================================================
# Java æœåŠ¡ç®¡ç†è„šæœ¬ï¼ˆLinux/macOS é€šç”¨ï¼Œå…¼å®¹ /bin/shï¼‰
# ==========================================================

JAR_NAME="yeah-admin.jar"
PORT=8080
JAVA_OPTS="-Dlogging.level.org.springframework.security=DEBUG -Dlogging.level.com.yeshimin.yeahboot=DEBUG"
SPRING_OPTS="--yeah-boot.safe-mode=false;--yeah-boot.storage.impl.qiniu.access-key=******;--yeah-boot.storage.impl.qiniu.bucket=******;--yeah-boot.storage.impl.qiniu.domain=******;--yeah-boot.storage.impl.qiniu.public-domain=******;--yeah-boot.storage.impl.qiniu.secret-key=******;--yeah-boot.notification.aliyun.sms.access-key-id=******;--yeah-boot.notification.aliyun.sms.access-key-secret=******;--yeah-boot.notification.aliyun.sms.template-code=******;--yeah-boot.notification.aliyun.sms.sign-name=******"

BASE_DIR=$(cd "$(dirname "$0")" && pwd)
PID_DIR="$BASE_DIR/run"
mkdir -p "$PID_DIR"
PID_FILE="$PID_DIR/app.pid"

get_pid() {
  PID=""
  if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ! ps -p "$PID" > /dev/null 2>&1; then
      rm -f "$PID_FILE"
      PID=""
    fi
  fi
  if [ -z "$PID" ]; then
    PID=$(ps -ef | grep "java .*${JAR_NAME}" | grep -v grep | awk '{print $2}' | head -n 1)
  fi
  echo "$PID"
}

start() {
  PID=$(get_pid)
  if [ -n "$PID" ]; then
    echo "âš ï¸  æœåŠ¡å·²åœ¨è¿è¡Œ (PID=$PID)"
    exit 0
  fi

  echo "ğŸš€ å¯åŠ¨æœåŠ¡: $JAR_NAME (ç«¯å£: $PORT)..."
  #nohup java $JAVA_OPTS -jar "$JAR_NAME" $SPRING_OPTS --server.port="$PORT" > /dev/null 2>&1 &
  nohup java $JAVA_OPTS -jar "$JAR_NAME" $SPRING_OPTS --server.port="$PORT" 2>&1 &
  echo $! > "$PID_FILE"

  sleep 1
  PID=$(get_pid)
  if [ -n "$PID" ]; then
    echo "âœ… å¯åŠ¨æˆåŠŸï¼ŒPID=$PID"
  else
    echo "âŒ å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‘½ä»¤æˆ–ç¯å¢ƒ"
  fi
}

stop() {
  PID=$(get_pid)
  if [ -z "$PID" ]; then
    echo "â„¹ï¸  æœåŠ¡æœªè¿è¡Œ"
    return
  fi

  echo "ğŸ›‘ åœæ­¢æœåŠ¡ (PID=$PID)..."
  kill "$PID"
  i=0
  while [ $i -lt 10 ]; do
    sleep 0.5
    if ! ps -p "$PID" > /dev/null 2>&1; then
      rm -f "$PID_FILE"
      echo "âœ… å·²åœæ­¢"
      return
    fi
    i=$((i+1))
  done

  echo "âš ï¸  æ­£å¸¸åœæ­¢å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ€è¿›ç¨‹..."
  kill -9 "$PID"
  rm -f "$PID_FILE"
  echo "âœ… å¼ºåˆ¶åœæ­¢å®Œæˆ"
}

status() {
  PID=$(get_pid)
  if [ -n "$PID" ]; then
    echo "ğŸŸ¢ æœåŠ¡æ­£åœ¨è¿è¡Œ (PID=$PID)"
  else
    echo "ğŸ”´ æœåŠ¡æœªè¿è¡Œ"
  fi
}

restart() {
  stop
  sleep 1
  start
}

CMD=""
while [ $# -gt 0 ]; do
  case "$1" in
    start|stop|restart|status)
      CMD="$1"
      shift
      ;;
    -j|--jar)
      JAR_NAME="$2"
      shift 2
      ;;
    -p|--port)
      PORT="$2"
      shift 2
      ;;
    *)
      echo "æœªçŸ¥å‚æ•°: $1"
      echo "ç”¨æ³•: $0 {start|stop|restart|status} [-j jaræ–‡ä»¶å] [-p ç«¯å£]"
      exit 1
      ;;
  esac
done

case "$CMD" in
  start) start ;;
  stop) stop ;;
  restart) restart ;;
  status) status ;;
  *)
    echo "ç”¨æ³•: $0 {start|stop|restart|status} [-j jaræ–‡ä»¶å] [-p ç«¯å£]"
    exit 1
    ;;
esac

