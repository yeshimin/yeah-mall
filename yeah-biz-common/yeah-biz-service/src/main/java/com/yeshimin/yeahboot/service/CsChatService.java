package com.yeshimin.yeahboot.service;import com.alibaba.fastjson2.JSON;import com.alibaba.fastjson2.JSONWriter;import com.yeshimin.yeahboot.common.common.enums.AuthSubjectEnum;import com.yeshimin.yeahboot.common.common.exception.BaseException;import com.yeshimin.yeahboot.data.common.enums.CsMsgDirectionEnum;import com.yeshimin.yeahboot.data.common.enums.CsMsgTypeEnum;import com.yeshimin.yeahboot.data.domain.entity.CsConversationEntity;import com.yeshimin.yeahboot.data.domain.entity.MemberEntity;import com.yeshimin.yeahboot.data.domain.entity.ShopEntity;import com.yeshimin.yeahboot.data.repository.CsConversationRepo;import com.yeshimin.yeahboot.data.repository.CsMessageRepo;import com.yeshimin.yeahboot.data.repository.MemberRepo;import com.yeshimin.yeahboot.data.repository.ShopRepo;import com.yeshimin.yeahboot.ws.command.MsgCommand;import com.yeshimin.yeahboot.ws.mq.command.BaseCommand;import com.yeshimin.yeahboot.ws.websocket.service.WebSocketService;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.lang.Nullable;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.util.Objects;/** * 客服聊天服务，多端共用 */@Slf4j@Service@RequiredArgsConstructorpublic class CsChatService {    private final ShopRepo shopRepo;    private final MemberRepo memberRepo;    private final CsConversationRepo csConversationRepo;    private final CsMessageRepo csMessageRepo;    private final WebSocketService wsService;    private final ValidateService validateService;    /**     * 处理买家发送给商家的消息     */    @Transactional(rollbackFor = Exception.class)    public void handleMsgMem2Mch(BaseCommand baseCommand, String userId) {        MsgCommand command = MsgCommand.parse(baseCommand);        MsgCommand.Payload payload = command.getPayload();        // 检查参数        if (validateService.hasError(payload)) {            throw new BaseException("参数错误");        }//        Long shopId = payload.getShopId();//        Long mchId = payload.getTo();//        Long memberId = payload.getFrom();//        // 检查：shopId是否正确//        ShopEntity shop = shopRepo.findOneById(shopId);//        if (shop == null) {//            throw new BaseException("shopId参数错误");//        }//        // 检查：memberId是否正确//        if (!Objects.equals(userId, String.valueOf(memberId))) {//            throw new BaseException("from参数错误");//        }//        // 检查：mchId是否正确//        if (!Objects.equals(shop.getMchId(), mchId)) {//            throw new BaseException("to参数错误");//        }        // 检查：type是否正确        CsMsgTypeEnum msgType = CsMsgTypeEnum.of(String.valueOf(payload.getType()));        if (msgType == null) {            throw new BaseException("type参数错误");        }//        // 获取会话，如果不存在则创建//        CsConversationEntity conversation = csConversationRepo.getOrCreateOne(mchId, shopId, memberId);        // 查询会话        CsConversationEntity conversation = csConversationRepo.getOneById(payload.getConversationId(), "会话不存在");        if (!Objects.equals(userId, String.valueOf(conversation.getMemberId()))) {            throw new BaseException("会话权限错误");        }        // 创建消息        csMessageRepo.createOne(conversation, CsMsgDirectionEnum.MEM2MCH.getIntValue(),                conversation.getMemberId(), conversation.getMchId(), payload.getContent(), payload.getType());        // 发送给商家        wsService.sendMessageToUser(JSON.toJSONString(command),                AuthSubjectEnum.MERCHANT.getValue(), String.valueOf(conversation.getMchId()));    }    /**     * 处理商家发送给买家的消息     */    @Transactional(rollbackFor = Exception.class)    public void handleMsgMch2Mem(BaseCommand baseCommand, String userId) {        MsgCommand command = MsgCommand.parse(baseCommand);        MsgCommand.Payload payload = command.getPayload();        // 检查参数        if (validateService.hasError(payload)) {            throw new BaseException("参数错误");        }//        Long shopId = payload.getShopId();//        Long mchId = payload.getFrom();//        Long memberId = payload.getTo();//        // 检查：shopId是否正确//        ShopEntity shop = shopRepo.findOneById(shopId);//        if (shop == null) {//            throw new BaseException("shopId参数错误");//        }//        // 检查：mchId是否正确//        if (!Objects.equals(userId, String.valueOf(mchId)) ||//                !Objects.equals(shop.getMchId(), mchId)) {//            throw new BaseException("from参数错误");//        }//        // 检查：memberId是否正确//        MemberEntity member = memberRepo.findOneById(memberId);//        if (member == null) {//            throw new BaseException("to参数错误");//        }        // 检查：type是否正确        CsMsgTypeEnum msgType = CsMsgTypeEnum.of(String.valueOf(payload.getType()));        if (msgType == null) {            throw new BaseException("type参数错误");        }//        // 获取会话，必须存在，否则报错//        CsConversationEntity conversation = csConversationRepo.findOneForUnique(mchId, shopId, memberId);//        if (conversation == null) {//            throw new BaseException("会话不存在");//        }        CsConversationEntity conversation = csConversationRepo.getOneById(payload.getConversationId(), "会话不存在");        if (!Objects.equals(userId, String.valueOf(conversation.getMchId()))) {            throw new BaseException("会话权限错误");        }        // 创建消息        csMessageRepo.createOne(conversation, CsMsgDirectionEnum.MCH2MEM.getIntValue(),                conversation.getMchId(), conversation.getMemberId(), payload.getContent(), payload.getType());        // 发送给买家        wsService.sendMessageToUser(JSON.toJSONString(command),                AuthSubjectEnum.APP.getValue(), String.valueOf(conversation.getMemberId()));    }}