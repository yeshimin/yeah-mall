package com.yeshimin.yeahboot.service;import com.yeshimin.yeahboot.data.common.enums.OrderStatusEnum;import com.yeshimin.yeahboot.data.domain.entity.*;import com.yeshimin.yeahboot.data.domain.vo.OrderShopProductVo;import com.yeshimin.yeahboot.data.domain.vo.ProductSpecOptVo;import com.yeshimin.yeahboot.data.repository.*;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.time.LocalDateTime;import java.util.*;import java.util.stream.Collectors;/** * 订单详情，多端共用 */@Slf4j@Service@RequiredArgsConstructorpublic class OrderService {    private final ProductSpuRepo productSpuRepo;    private final ShopRepo shopRepo;    private final ProductSkuSpecRepo productSkuSpecRepo;    private final ProductSpecDefRepo productSpecDefRepo;    private final ProductSpecOptDefRepo productSpecOptDefRepo;    private final OrderRepo orderRepo;    private final ProductSkuRepo productSkuRepo;    private final OrderItemRepo orderItemRepo;    /**     * 订单详情场景     */    public List<OrderShopProductVo> queryOrderShopProductForOrderDetail(List<ProductSkuEntity> listSku,                                                                        List<Long> skuIds,                                                                        List<OrderItemEntity> orderItems) {        // 查询店铺信息        Set<Long> shopIds = listSku.stream().map(ProductSkuEntity::getShopId).collect(Collectors.toSet());        List<ShopEntity> listShop = shopRepo.findListByIds(shopIds);        Map<Long, ShopEntity> mapShop = listShop.stream().collect(Collectors.toMap(ShopEntity::getId, shop -> shop));        // 查询spu信息        Set<Long> spuIds = listSku.stream().map(ProductSkuEntity::getSpuId).collect(Collectors.toSet());        List<ProductSpuEntity> listSpu = productSpuRepo.findListByIds(spuIds);        Map<Long, ProductSpuEntity> mapSpu = listSpu.stream().collect(Collectors.toMap(ProductSpuEntity::getId, spu -> spu));        // 查询sku规格        List<ProductSkuSpecEntity> listSkuSpec = productSkuSpecRepo.findListBySkuIds(skuIds);        Map<Long, List<ProductSkuSpecEntity>> mapSkuSpecs = listSkuSpec.stream().collect(Collectors.groupingBy(ProductSkuSpecEntity::getSkuId));        // 查询specs        Set<Long> specIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getSpecId).collect(Collectors.toSet());        Map<Long, ProductSpecDefEntity> mapSpecDef = productSpecDefRepo.findListByIds(specIds)                .stream().collect(Collectors.toMap(ProductSpecDefEntity::getId, v -> v));        // 查询opts        Set<Long> optIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getOptId).collect(Collectors.toSet());        Map<Long, ProductSpecOptDefEntity> mapOptDef = productSpecOptDefRepo.findListByIds(optIds)                .stream().collect(Collectors.toMap(ProductSpecOptDefEntity::getId, v -> v));        return orderItems.stream().map(orderItem -> {            OrderShopProductVo vo = new OrderShopProductVo();            vo.setId(orderItem.getId());            vo.setShopId(orderItem.getShopId());            Optional.ofNullable(mapShop.get(orderItem.getShopId())).ifPresent(shop -> vo.setShopName(shop.getShopName()));            vo.setSpuId(orderItem.getSpuId());            Optional.ofNullable(mapSpu.get(orderItem.getSpuId())).ifPresent(spu -> {                vo.setSpuName(spu.getName());                vo.setSpuMainImage(spu.getMainImage());            });            vo.setSkuId(orderItem.getSkuId());            vo.setSkuName(orderItem.getSkuName());            vo.setPrice(orderItem.getUnitPrice());            vo.setQuantity(orderItem.getQuantity());            // specs            List<ProductSkuSpecEntity> skuSpecs =                    mapSkuSpecs.getOrDefault(orderItem.getSkuId(), Collections.emptyList());            List<ProductSpecOptVo> listSpecOptVo = skuSpecs.stream().map(skuSpec -> {                ProductSpecOptVo optVo = new ProductSpecOptVo();                // set spec                Optional.ofNullable(mapSpecDef.get(skuSpec.getSpecId())).ifPresent(specDef -> {                    optVo.setSpecId(specDef.getId());                    optVo.setSpecName(specDef.getSpecName());                });                // set opt                Optional.ofNullable(mapOptDef.get(skuSpec.getOptId())).ifPresent(optDef -> {                    optVo.setOptId(optDef.getId());                    optVo.setOptName(optDef.getOptName());                });                // set sort                optVo.setSort(skuSpec.getSort());                return optVo;            }).collect(Collectors.toList());            vo.setSpecs(listSpecOptVo);            // 订单ID            vo.setOrderId(orderItem.getOrderId());            return vo;        }).collect(Collectors.toList());    }    /**     * 取消订单     */    @Transactional(rollbackFor = Exception.class)    public void cancelOrder(OrderEntity order, String closeReason) {        // 检查：订单状态是否为待付款        if (!Objects.equals(order.getStatus(), OrderStatusEnum.WAIT_PAY.getValue())) {            throw new RuntimeException("仅当前订单状态为【待付款】时，才能取消订单");        }        boolean updateStatusSuccess = orderRepo.updateStatus(                order.getId(), OrderStatusEnum.WAIT_PAY.getValue(), OrderStatusEnum.CLOSED.getValue());        if (!updateStatusSuccess) {            throw new RuntimeException("订单取消失败，请稍后重试");        }        order.setStatus(OrderStatusEnum.CLOSED.getValue());        order.setCloseTime(LocalDateTime.now());        order.setCloseReason(closeReason);        order.updateById();        // 查询订单明细        List<OrderItemEntity> orderItems = orderItemRepo.findListByOrderId(order.getId());        // 释放库存        for (OrderItemEntity item : orderItems) {            productSkuRepo.increaseStock(item.getSkuId(), item.getQuantity());        }        // 退回优惠券之类的逻辑 TODO 做优惠券的时候再处理    }}