package com.yeshimin.yeahboot.service;import com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper;import com.yeshimin.yeahboot.common.utils.WxPayUtils;import com.yeshimin.yeahboot.data.common.enums.OrderStatusEnum;import com.yeshimin.yeahboot.data.common.enums.RefundStatusEnum;import com.yeshimin.yeahboot.data.common.enums.WxRefundStatusEnum;import com.yeshimin.yeahboot.data.domain.entity.*;import com.yeshimin.yeahboot.data.domain.vo.OrderShopProductVo;import com.yeshimin.yeahboot.data.domain.vo.ProductSpecOptVo;import com.yeshimin.yeahboot.data.repository.*;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.time.LocalDateTime;import java.util.*;import java.util.stream.Collectors;/** * 订单详情，多端共用 */@Slf4j@Service@RequiredArgsConstructorpublic class OrderService {    private final ProductSpuRepo productSpuRepo;    private final ShopRepo shopRepo;    private final ProductSkuSpecRepo productSkuSpecRepo;    private final ProductSpecDefRepo productSpecDefRepo;    private final ProductSpecOptDefRepo productSpecOptDefRepo;    private final OrderRepo orderRepo;    private final OrderRefundRepo orderRefundRepo;    private final ProductSkuRepo productSkuRepo;    private final OrderItemRepo orderItemRepo;    /**     * 订单详情场景     */    public List<OrderShopProductVo> queryOrderShopProductForOrderDetail(List<ProductSkuEntity> listSku,                                                                        List<Long> skuIds,                                                                        List<OrderItemEntity> orderItems) {        // 查询店铺信息        Set<Long> shopIds = listSku.stream().map(ProductSkuEntity::getShopId).collect(Collectors.toSet());        List<ShopEntity> listShop = shopRepo.findListByIds(shopIds);        Map<Long, ShopEntity> mapShop = listShop.stream().collect(Collectors.toMap(ShopEntity::getId, shop -> shop));        // 查询spu信息        Set<Long> spuIds = listSku.stream().map(ProductSkuEntity::getSpuId).collect(Collectors.toSet());        List<ProductSpuEntity> listSpu = productSpuRepo.findListByIds(spuIds);        Map<Long, ProductSpuEntity> mapSpu = listSpu.stream().collect(Collectors.toMap(ProductSpuEntity::getId, spu -> spu));        // 查询sku规格        List<ProductSkuSpecEntity> listSkuSpec = productSkuSpecRepo.findListBySkuIds(skuIds);        Map<Long, List<ProductSkuSpecEntity>> mapSkuSpecs = listSkuSpec.stream().collect(Collectors.groupingBy(ProductSkuSpecEntity::getSkuId));        // 查询specs        Set<Long> specIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getSpecId).collect(Collectors.toSet());        Map<Long, ProductSpecDefEntity> mapSpecDef = productSpecDefRepo.findListByIds(specIds)                .stream().collect(Collectors.toMap(ProductSpecDefEntity::getId, v -> v));        // 查询opts        Set<Long> optIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getOptId).collect(Collectors.toSet());        Map<Long, ProductSpecOptDefEntity> mapOptDef = productSpecOptDefRepo.findListByIds(optIds)                .stream().collect(Collectors.toMap(ProductSpecOptDefEntity::getId, v -> v));        return orderItems.stream().map(orderItem -> {            OrderShopProductVo vo = new OrderShopProductVo();            vo.setId(orderItem.getId());            vo.setShopId(orderItem.getShopId());            Optional.ofNullable(mapShop.get(orderItem.getShopId())).ifPresent(shop -> vo.setShopName(shop.getShopName()));            vo.setSpuId(orderItem.getSpuId());            Optional.ofNullable(mapSpu.get(orderItem.getSpuId())).ifPresent(spu -> {                vo.setSpuName(spu.getName());                vo.setSpuMainImage(spu.getMainImage());            });            vo.setSkuId(orderItem.getSkuId());            vo.setSkuName(orderItem.getSkuName());            vo.setPrice(orderItem.getUnitPrice());            vo.setQuantity(orderItem.getQuantity());            // specs            List<ProductSkuSpecEntity> skuSpecs =                    mapSkuSpecs.getOrDefault(orderItem.getSkuId(), Collections.emptyList());            List<ProductSpecOptVo> listSpecOptVo = skuSpecs.stream().map(skuSpec -> {                ProductSpecOptVo optVo = new ProductSpecOptVo();                // set spec                Optional.ofNullable(mapSpecDef.get(skuSpec.getSpecId())).ifPresent(specDef -> {                    optVo.setSpecId(specDef.getId());                    optVo.setSpecName(specDef.getSpecName());                });                // set opt                Optional.ofNullable(mapOptDef.get(skuSpec.getOptId())).ifPresent(optDef -> {                    optVo.setOptId(optDef.getId());                    optVo.setOptName(optDef.getOptName());                });                // set sort                optVo.setSort(skuSpec.getSort());                return optVo;            }).collect(Collectors.toList());            vo.setSpecs(listSpecOptVo);            // 订单ID            vo.setOrderId(orderItem.getOrderId());            return vo;        }).collect(Collectors.toList());    }    /**     * 取消订单     */    @Transactional(rollbackFor = Exception.class)    public void cancelOrder(OrderEntity order, String closeReason) {        // 检查：订单状态是否为待付款        if (!Objects.equals(order.getStatus(), OrderStatusEnum.WAIT_PAY.getValue())) {            throw new RuntimeException("仅当前订单状态为【待付款】时，才能取消订单");        }        boolean updateStatusSuccess = orderRepo.updateStatus(                order.getId(), OrderStatusEnum.WAIT_PAY.getValue(), OrderStatusEnum.CLOSED.getValue());        if (!updateStatusSuccess) {            throw new RuntimeException("订单取消失败，请稍后重试");        }        order.setStatus(OrderStatusEnum.CLOSED.getValue());        order.setCloseTime(LocalDateTime.now());        order.setCloseReason(closeReason);        order.updateById();        // 查询订单明细        List<OrderItemEntity> orderItems = orderItemRepo.findListByOrderId(order.getId());        // 释放库存        for (OrderItemEntity item : orderItems) {            productSkuRepo.increaseStock(item.getSkuId(), item.getQuantity());        }        // 退回优惠券之类的逻辑 TODO 做优惠券的时候再处理    }    /**     * 处理支付成功     */    @Transactional(rollbackFor = Exception.class)    public boolean handlePaySuccess(WxPayUtils.Notification notification) {        String outTradeNo = notification.getOrderInfo().getOutTradeNo();        // 查询业务订单        OrderEntity order = orderRepo.findOneByOrderNo(outTradeNo);        // 如果业务数据不存在，返回成功，避免重复通知        if (order == null) {            log.warn("处理支付成功失败，订单不存在，outTradeNo={}", outTradeNo);            return true;        }        // 仅处理当前状态为【待付款】的情况，其他情况不做处理，返回成功        if (!OrderStatusEnum.WAIT_PAY.getValue().equals(order.getStatus())) {            log.info("处理支付成功失败，订单状态非待付款，outTradeNo={}, status={}", outTradeNo, order.getStatus());            return true;        }        // 更新订单状态        boolean success = orderRepo.updateStatus(order.getId(),                OrderStatusEnum.WAIT_PAY.getValue(), OrderStatusEnum.WAIT_SHIP.getValue());        // 可能已经处理过了，返回成功        if (!success) {            log.info("处理支付成功失败，订单状态更新失败，可能已经处理过了，outTradeNo={}", outTradeNo);            return true;        }        // 更新支付成功时间        LambdaUpdateWrapper<OrderEntity> updateWrapper = new LambdaUpdateWrapper<>();        updateWrapper.eq(OrderEntity::getId, order.getId())                .set(OrderEntity::getPaySuccessTime, notification.getOrderInfo().getSuccessTime().toLocalDateTime());        orderRepo.update(updateWrapper);        return true;    }    /**     * 处理退款成功     */    @Transactional(rollbackFor = Exception.class)    public boolean handleRefundNotify(WxPayUtils.Notification notification) {        WxPayUtils.RefundInfo refundInfo = notification.getRefundInfo();        String orderNo = refundInfo.getOutTradeNo();        String refundNo = refundInfo.getOutRefundNo();        // 查询订单记录        OrderEntity order = orderRepo.findOneByOrderNo(orderNo);        if (order == null) {            log.warn("处理退款通知失败，订单不存在，orderNo={}", orderNo);            return true;        }        // 查询退款记录        OrderRefundEntity orderRefund = orderRefundRepo.findOneByRefundNo(refundNo);        // 如果业务数据不存在，返回成功，避免重复通知        if (orderRefund == null) {            log.warn("处理退款通知失败，退款记录不存在，refundNo={}", refundNo);            return true;        }        // 更新退款记录        LambdaUpdateWrapper<OrderRefundEntity> updateWrapper = new LambdaUpdateWrapper<>();        updateWrapper.eq(OrderRefundEntity::getId, orderRefund.getId())                .set(OrderRefundEntity::getRefundStatus, refundInfo.getRefundStatus())                .set(OrderRefundEntity::getSuccessTime, refundInfo.getSuccessTime().toLocalDateTime())                .set(OrderRefundEntity::getUserReceivedAccount, refundInfo.getUserReceivedAccount())                .set(OrderRefundEntity::getSummary, notification.getSummary())                .set(OrderRefundEntity::getRealTotalAmount, refundInfo.getAmount().getTotal())                .set(OrderRefundEntity::getRealRefundAmount, refundInfo.getAmount().getRefund());        orderRefundRepo.update(updateWrapper);        // 如果订单状态为【退款】，更新订单退款状态        if (Objects.equals(order.getStatus(), OrderStatusEnum.REFUND.getValue())) {            WxRefundStatusEnum wxRefundStatus = WxRefundStatusEnum.of(refundInfo.getRefundStatus());            switch (Objects.requireNonNull(wxRefundStatus)) {                case SUCCESS:                    orderRepo.updateRefundStatus2(order.getId(), RefundStatusEnum.SUCCESS.getValue(),                            notification.getSummary(), refundInfo.getSuccessTime().toLocalDateTime());                    break;                case CLOSED:                case ABNORMAL:                    orderRepo.updateRefundStatus2(order.getId(), RefundStatusEnum.FAILED.getValue(),                            notification.getSummary(), refundInfo.getSuccessTime().toLocalDateTime());                    break;                case PROCESSING:                    orderRepo.updateRefundStatus2(order.getId(), RefundStatusEnum.PROCESSING.getValue(),                            notification.getSummary(), refundInfo.getSuccessTime().toLocalDateTime());                    break;                default:                    break;            }        }        return true;    }}