package com.yeshimin.yeahboot.app.service;import cn.hutool.core.util.StrUtil;import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;import com.baomidou.mybatisplus.core.metadata.IPage;import com.baomidou.mybatisplus.extension.plugins.pagination.Page;import com.wechat.pay.java.service.payments.jsapi.model.PrepayResponse;import com.wechat.pay.java.service.payments.model.Transaction;import com.yeshimin.yeahboot.app.common.enums.OrderAggreStatusEnum;import com.yeshimin.yeahboot.app.common.enums.OrderSceneEnum;import com.yeshimin.yeahboot.app.common.enums.OrderStatusEnum;import com.yeshimin.yeahboot.app.common.enums.WxPayOrderStatusEnum;import com.yeshimin.yeahboot.app.common.utils.WxPayUtils;import com.yeshimin.yeahboot.app.domain.dto.*;import com.yeshimin.yeahboot.app.domain.vo.*;import com.yeshimin.yeahboot.common.common.config.mybatis.QueryHelper;import com.yeshimin.yeahboot.common.common.exception.BaseException;import com.yeshimin.yeahboot.common.service.IdService;import com.yeshimin.yeahboot.data.domain.entity.*;import com.yeshimin.yeahboot.data.domain.vo.ProductSpecOptVo;import com.yeshimin.yeahboot.data.repository.*;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.math.BigDecimal;import java.util.*;import java.util.stream.Collectors;@Slf4j@Service@RequiredArgsConstructorpublic class AppOrderService {    // 待评价状态集合    private static final List<String> WAIT_COMMENT_STATUS = Arrays.asList(            OrderStatusEnum.COMPLETED.getValue(),            OrderStatusEnum.REFUND.getValue(),            OrderStatusEnum.AFTER_SALE.getValue());    // 退款和售后状态集合    private static final List<String> REFUND_AND_AFTER_SALE_STATUS = Arrays.asList(            OrderStatusEnum.REFUND.getValue(),            OrderStatusEnum.AFTER_SALE.getValue()    );    // 微信支付成功回调事件类型    private static final String WX_PAY_NOTIFY_EVENT_TYPE = "TRANSACTION.SUCCESS";    private final ProductSkuRepo productSkuRepo;    private final ProductSpuRepo productSpuRepo;    private final OrderItemRepo orderItemRepo;    private final OrderRepo orderRepo;    private final ShopRepo shopRepo;    private final ProductSkuSpecRepo productSkuSpecRepo;    private final ProductSpecDefRepo productSpecDefRepo;    private final ProductSpecOptDefRepo productSpecOptDefRepo;    private final CartItemRepo cartItemRepo;    private final MemberAddressRepo memberAddressRepo;    private final IdService idService;    private final WxPayService wxPayService;    private final AppOrderStatusService appOrderStatusService;    /**     * 提交订单     */    @Transactional(rollbackFor = Exception.class)    public OrderEntity submit(Long userId, OrderSubmitDto dto) {        // 检查：收货地址        MemberAddressEntity address = memberAddressRepo.findOneById(dto.getAddressId());        if (address == null || !Objects.equals(address.getMemberId(), userId)) {            throw new BaseException("收货地址无效");        }        // 查询sku        Set<Long> skuIds = dto.getItems().stream().map(OrderItemDto::getSkuId).collect(Collectors.toSet());        if (skuIds.size() != dto.getItems().size()) {            throw new BaseException("订单项中存在重复的SKU ID");        }        List<ProductSkuEntity> listSku = productSkuRepo.findListByIds(skuIds);        if (listSku.size() != skuIds.size()) {            throw new BaseException("订单项中存在无效的SKU ID");        }        // 检查：是否属于多家店铺        Set<Long> shopIds = listSku.stream().map(ProductSkuEntity::getShopId).collect(Collectors.toSet());        if (shopIds.size() > 1) {            throw new BaseException("订单项中存在多家店铺的SKU");        }        // 检查库存        for (OrderItemDto item : dto.getItems()) {            ProductSkuEntity sku = listSku.stream()                    .filter(s -> s.getId().equals(item.getSkuId()))                    .findFirst()                    .orElseThrow(() -> new BaseException("SKU ID " + item.getSkuId() + " 不存在"));            if (sku.getStock() < item.getQuantity()) {                throw new BaseException("SKU " + sku.getName() + " 库存不足");            }            // 扣减库存            boolean r = productSkuRepo.occurStock(item.getSkuId(), item.getQuantity());            log.info("sku[{},{}] 扣减库存结果：{}", sku.getId(), sku.getName(), r);            if (!r) {                throw new BaseException("SKU " + sku.getName() + " 库存不足");            }        }        // 创建订单        OrderEntity order = new OrderEntity();        List<OrderItemEntity> orderItems = new ArrayList<>(dto.getItems().size());        // 生成订单编号        final String orderNo = idService.nextEncodedId();        // 查询spu        Set<Long> spuIds = listSku.stream().map(ProductSkuEntity::getSpuId).collect(Collectors.toSet());        Map<Long, ProductSpuEntity> mapSpu = productSpuRepo.findListByIds(spuIds)                .stream().collect(Collectors.toMap(ProductSpuEntity::getId, spu -> spu));        // 总金额        BigDecimal totalAmount = BigDecimal.ZERO;        // 生成订单明细        for (OrderItemDto item : dto.getItems()) {            ProductSkuEntity sku = listSku.stream()                    .filter(s -> s.getId().equals(item.getSkuId()))                    .findFirst()                    .orElseThrow(() -> new BaseException("SKU ID " + item.getSkuId() + " 不存在"));            ProductSpuEntity spu = mapSpu.get(sku.getSpuId());            if (spu == null) {                throw new BaseException("SPU ID " + sku.getSpuId() + " 不存在");            }            OrderItemEntity orderItem = new OrderItemEntity();            orderItem.setMchId(sku.getMchId());            orderItem.setShopId(sku.getShopId());            orderItem.setMemberId(userId);            orderItem.setOrderNo(orderNo);            orderItem.setSkuId(sku.getId());            orderItem.setSkuName(sku.getName());            orderItem.setSpuId(sku.getSpuId());            orderItem.setSpuName(spu.getName());            orderItem.setUnitPrice(sku.getPrice());            orderItem.setQuantity(item.getQuantity());            orderItem.setTotalPrice(sku.getPrice().multiply(new BigDecimal(item.getQuantity())));            orderItems.add(orderItem);            // 累加总金额            totalAmount = totalAmount.add(orderItem.getTotalPrice());        }        // 保存订单        Optional.ofNullable(listSku.get(0)).ifPresent(sku -> {            order.setMchId(sku.getMchId());            order.setShopId(sku.getShopId());        });        order.setMemberId(userId);        order.setOrderNo(orderNo);        order.setTotalAmount(totalAmount);        order.setStatus(OrderStatusEnum.WAIT_PAY.getValue()); // 设置订单状态为待付款        // 保存买家收货地址信息        this.setOrderReceiverAddress(order, address);        order.insert();        // 保存订单明细        orderItems.forEach(orderItem -> orderItem.setOrderId(order.getId()));        orderItemRepo.saveBatch(orderItems);        // 如果是【购物车下单】场景，则清除对应的购物车商品        if (Objects.equals(dto.getScene(), OrderSceneEnum.CART.getValue())) {            if (!skuIds.isEmpty()) {                cartItemRepo.deleteByMemberIdAndSkuIds(userId, skuIds);            }        }        return order;    }    /**     * 生成支付信息     */    @Transactional(rollbackFor = Exception.class)    public WxPayInfoVo genPayInfo(Long userId, String orderNo) {        // 查询订单        OrderEntity order = orderRepo.findOneByOrderNo(orderNo);        if (order == null) {            throw new BaseException("订单未找到");        }        if (!Objects.equals(order.getMemberId(), userId)) {            throw new BaseException("无该订单权限");        }        String prepayId;        // 如果还没有预支付订单，则创建一个        if (StrUtil.isBlank(order.getWxPrepayId())) {            PrepayResponse response =                    wxPayService.prepay("商品描述" + System.currentTimeMillis(), order.getOrderNo());            prepayId = response.getPrepayId();            // 更新            order.setWxPrepayId(prepayId);            order.updateById();        } else {            prepayId = order.getWxPrepayId();        }        return wxPayService.genWxPayInfo(prepayId);    }    /**     * 查询支付订单信息     */    public Transaction queryPayOrderInfo(Long userId, String orderNo) {        // 查询业务订单        OrderEntity order = orderRepo.findOneByOrderNo(orderNo);        if (order == null) {            throw new BaseException("订单未找到");        }        if (!Objects.equals(order.getMemberId(), userId)) {            throw new BaseException("无该订单权限");        }        return wxPayService.queryOrderByOutTradeNo(orderNo);    }    /**     * 查询订单支付结果     */    public OrderPayResultVo queryPayResult(Long userId, String orderNo) {        // 查询业务订单        OrderEntity order = orderRepo.findOneByOrderNo(orderNo);        if (order == null) {            throw new BaseException("订单未找到");        }        if (!Objects.equals(order.getMemberId(), userId)) {            throw new BaseException("无该订单权限");        }        OrderPayResultVo vo = new OrderPayResultVo();        vo.setOrderNo(order.getOrderNo());        vo.setPaySuccess(order.getPaySuccessTime() != null);        vo.setPaySuccessTime(order.getPaySuccessTime());        return vo;    }    /**     * 查询个人订单     */    public IPage<OrderShopVo> query(Long userId, Page<OrderEntity> page, OrderQueryDto dto) {        OrderAggreStatusEnum aggreStatus = OrderAggreStatusEnum.of(dto.getAggreStatus());        if (aggreStatus == null) {            LambdaQueryWrapper<OrderEntity> wrapper = QueryHelper.getQueryWrapper(dto, OrderEntity.class);            wrapper.eq(OrderEntity::getMemberId, userId);            return this.wrapOrderShopVo(orderRepo.page(page, wrapper));        }        if (aggreStatus.isEqualMode()) {            LambdaQueryWrapper<OrderEntity> wrapper = QueryHelper.getQueryWrapper(dto, OrderEntity.class);            wrapper.eq(OrderEntity::getMemberId, userId);            wrapper.eq(OrderEntity::getStatus, aggreStatus.toOrderStatusEnum().getValue());            return this.wrapOrderShopVo(orderRepo.page(page, wrapper));        } else if (aggreStatus.isInMode()) {            LambdaQueryWrapper<OrderEntity> wrapper = QueryHelper.getQueryWrapper(dto, OrderEntity.class);            wrapper.eq(OrderEntity::getMemberId, userId);            wrapper.in(OrderEntity::getStatus, REFUND_AND_AFTER_SALE_STATUS);            return this.wrapOrderShopVo(orderRepo.page(page, wrapper));        } else if (aggreStatus.isExtendMode()) {            LambdaQueryWrapper<OrderEntity> wrapper = QueryHelper.getQueryWrapper(dto, OrderEntity.class);            wrapper.eq(OrderEntity::getMemberId, userId);            wrapper.in(OrderEntity::getStatus, WAIT_COMMENT_STATUS);            wrapper.eq(OrderEntity::getReviewed, false);            return this.wrapOrderShopVo(orderRepo.page(page, wrapper));        } else {            throw new BaseException("订单聚合状态异常");        }    }    /**     * 查询个人订单数量     */    public OrderCountVo queryCount(Long userId) {        // 待付款数量        long waitPayCount = orderRepo.countByStatus(userId, OrderStatusEnum.WAIT_PAY.getValue());        // 待发货数量        long waitShipCount = orderRepo.countByStatus(userId, OrderStatusEnum.WAIT_SHIP.getValue());        // 待收货数量        long waitReceiveCount = orderRepo.countByStatus(userId, OrderStatusEnum.WAIT_RECEIVE.getValue());        // 待评价数量        long waitCommentCount = orderRepo.countByMemberIdAndStatusList(userId, WAIT_COMMENT_STATUS);        // 退款/售后数量        long refundAndAfterSaleCount = orderRepo.countByMemberIdAndStatusList(userId, REFUND_AND_AFTER_SALE_STATUS);        OrderCountVo vo = new OrderCountVo();        vo.setWaitPayCount(waitPayCount);        vo.setWaitShipCount(waitShipCount);        vo.setWaitReceiveCount(waitReceiveCount);        vo.setWaitCommentCount(waitCommentCount);        vo.setRefundAndAfterSaleCount(refundAndAfterSaleCount);        return vo;    }    /**     * 预览订单     */    public List<OrderShopVo> preview(Long userId, OrderPreviewDto dto) {        Set<Long> skuIds = dto.getItems().stream().map(OrderPreviewItemDto::getSkuId).collect(Collectors.toSet());        // to map        Map<Long, Integer> mapSkuQuantity = dto.getItems()                .stream().collect(Collectors.toMap(OrderPreviewItemDto::getSkuId, OrderPreviewItemDto::getQuantity));        // 查询sku        List<ProductSkuEntity> listSku = productSkuRepo.findListByIds(skuIds);        // 检查        if (listSku.size() != skuIds.size()) {            throw new BaseException("订单项中存在无效的SKU ID");        }        // --------------------------------------------------------------------------------        List<OrderShopProductVo> listOrderShopProductVo =                this.queryOrderShopProductForPreview(listSku, new ArrayList<>(skuIds), mapSkuQuantity);        // --------------------------------------------------------------------------------        // group by shop        Map<Long, List<OrderShopProductVo>> groupOrderShopProductVo = listOrderShopProductVo.stream().collect(Collectors.groupingBy(OrderShopProductVo::getShopId));        List<OrderShopVo> listOrderShopVo = new ArrayList<>();        for (Map.Entry<Long, List<OrderShopProductVo>> entry : groupOrderShopProductVo.entrySet()) {            Long shopId = entry.getKey();            List<OrderShopProductVo> items = entry.getValue();            OrderShopVo vo = new OrderShopVo();            vo.setShopId(shopId);            vo.setShopName(entry.getValue().get(0).getShopName());            vo.setItems(items);            listOrderShopVo.add(vo);        }        return listOrderShopVo;    }    /**     * 处理微信支付回调通知     */    public boolean handlePayNotify(String notifyData, String serial, String signature, String timestamp, String nonce) {        // 解密数据        WxPayUtils.Notification notification;        try {            notification = wxPayService.parsePayNotification(notifyData, serial, signature, timestamp, nonce);        } catch (Exception e) {            log.error("解析微信支付通知数据失败", e);            return false;        }        String eventType = notification.getEventType();        if (!Objects.equals(eventType, WX_PAY_NOTIFY_EVENT_TYPE)) {            log.error("微信支付通知非支付成功状态，eventType={}", eventType);            return false;        }        // 解析订单信息        WxPayUtils.OrderInfo orderInfo = notification.parseOrderInfo();        WxPayOrderStatusEnum tradeStateEnum = WxPayOrderStatusEnum.of(orderInfo.getTradeState());        boolean handleSuccess = true;        switch (Objects.requireNonNull(tradeStateEnum)) {            // 支付成功            case SUCCESS:                handleSuccess = appOrderStatusService.handlePaySuccess(notification);                break;            // 转入退款            case REFUND:                // todo                break;            // 未支付            case NOTPAY:                // todo                break;            // 已关闭            case CLOSED:                // todo                break;            default:                log.info("其他状态暂时不做处理，返回成功");                handleSuccess = false;                break;        }        return handleSuccess;    }    // ================================================================================    /**     * 订单实体类包装为订单店铺视图类     */    private IPage<OrderShopVo> wrapOrderShopVo(Page<OrderEntity> pageOrder) {        List<OrderEntity> orders = pageOrder.getRecords();        // 查询订单明细        List<Long> orderIds = orders.stream().map(OrderEntity::getId).collect(Collectors.toList());        List<OrderItemEntity> orderItems = orderItemRepo.findListByOrderIds(orderIds);        // 查询sku        Set<Long> skuIds = orderItems.stream().map(OrderItemEntity::getSkuId).collect(Collectors.toSet());        List<ProductSkuEntity> listSku = productSkuRepo.findListByIds(skuIds);        // --------------------------------------------------------------------------------        List<OrderShopProductVo> listOrderShopProductVo =                this.queryOrderShopProductForOrderList(listSku, new ArrayList<>(skuIds), orderItems);        // --------------------------------------------------------------------------------        // group by orderId, and wrap        Map<Long, List<OrderShopProductVo>> groupOrderShopProductVo =                listOrderShopProductVo.stream().collect(Collectors.groupingBy(OrderShopProductVo::getOrderId));        return pageOrder.convert(order -> {            List<OrderShopProductVo> items = groupOrderShopProductVo.get(order.getId());            OrderShopVo vo = new OrderShopVo();            vo.setShopId(order.getShopId());            vo.setShopName(items.get(0).getShopName());            vo.setItems(items);            // 订单信息            vo.setOrderNo(order.getOrderNo());            vo.setOrderStatus(order.getStatus());            vo.setCreateTime(order.getCreateTime());            vo.setPaySuccessTime(order.getPaySuccessTime());            return vo;        });    }    /**     * 订单预览场景     */    private List<OrderShopProductVo> queryOrderShopProductForPreview(List<ProductSkuEntity> listSku, List<Long> skuIds,                                                                     Map<Long, Integer> mapSkuQuantity) {        // 查询店铺信息        Set<Long> shopIds = listSku.stream().map(ProductSkuEntity::getShopId).collect(Collectors.toSet());        List<ShopEntity> listShop = shopRepo.findListByIds(shopIds);        Map<Long, ShopEntity> mapShop = listShop.stream().collect(Collectors.toMap(ShopEntity::getId, shop -> shop));        // 查询spu信息        Set<Long> spuIds = listSku.stream().map(ProductSkuEntity::getSpuId).collect(Collectors.toSet());        List<ProductSpuEntity> listSpu = productSpuRepo.findListByIds(spuIds);        Map<Long, ProductSpuEntity> mapSpu = listSpu.stream().collect(Collectors.toMap(ProductSpuEntity::getId, spu -> spu));        // 查询sku规格        List<ProductSkuSpecEntity> listSkuSpec = productSkuSpecRepo.findListBySkuIds(skuIds);        Map<Long, List<ProductSkuSpecEntity>> mapSkuSpecs = listSkuSpec.stream().collect(Collectors.groupingBy(ProductSkuSpecEntity::getSkuId));        // 查询specs        Set<Long> specIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getSpecId).collect(Collectors.toSet());        Map<Long, ProductSpecDefEntity> mapSpecDef = productSpecDefRepo.findListByIds(specIds)                .stream().collect(Collectors.toMap(ProductSpecDefEntity::getId, v -> v));        // 查询opts        Set<Long> optIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getOptId).collect(Collectors.toSet());        Map<Long, ProductSpecOptDefEntity> mapOptDef = productSpecOptDefRepo.findListByIds(optIds)                .stream().collect(Collectors.toMap(ProductSpecOptDefEntity::getId, v -> v));        return listSku.stream().map(sku -> {            OrderShopProductVo vo = new OrderShopProductVo();            vo.setShopId(sku.getShopId());            Optional.ofNullable(mapShop.get(sku.getShopId())).ifPresent(shop -> vo.setShopName(shop.getShopName()));            vo.setSpuId(sku.getSpuId());            Optional.ofNullable(mapSpu.get(sku.getSpuId())).ifPresent(spu -> {                vo.setSpuName(spu.getName());                vo.setSpuMainImage(spu.getMainImage());            });            vo.setSkuId(sku.getId());            vo.setSkuName(sku.getName());            vo.setPrice(sku.getPrice());            vo.setQuantity(mapSkuQuantity.get(sku.getId()));            // specs            List<ProductSkuSpecEntity> skuSpecs =                    mapSkuSpecs.getOrDefault(sku.getId(), Collections.emptyList());            List<ProductSpecOptVo> listSpecOptVo = skuSpecs.stream().map(skuSpec -> {                ProductSpecOptVo optVo = new ProductSpecOptVo();                // set spec                Optional.ofNullable(mapSpecDef.get(skuSpec.getSpecId())).ifPresent(specDef -> {                    optVo.setSpecId(specDef.getId());                    optVo.setSpecName(specDef.getSpecName());                });                // set opt                Optional.ofNullable(mapOptDef.get(skuSpec.getOptId())).ifPresent(optDef -> {                    optVo.setOptId(optDef.getId());                    optVo.setOptName(optDef.getOptName());                });                // set sort                optVo.setSort(skuSpec.getSort());                return optVo;            }).collect(Collectors.toList());            vo.setSpecs(listSpecOptVo);            return vo;        }).collect(Collectors.toList());    }    /**     * 订单列表场景     */    private List<OrderShopProductVo> queryOrderShopProductForOrderList(List<ProductSkuEntity> listSku,                                                                       List<Long> skuIds,                                                                       List<OrderItemEntity> orderItems) {        // 查询店铺信息        Set<Long> shopIds = listSku.stream().map(ProductSkuEntity::getShopId).collect(Collectors.toSet());        List<ShopEntity> listShop = shopRepo.findListByIds(shopIds);        Map<Long, ShopEntity> mapShop = listShop.stream().collect(Collectors.toMap(ShopEntity::getId, shop -> shop));        // 查询spu信息        Set<Long> spuIds = listSku.stream().map(ProductSkuEntity::getSpuId).collect(Collectors.toSet());        List<ProductSpuEntity> listSpu = productSpuRepo.findListByIds(spuIds);        Map<Long, ProductSpuEntity> mapSpu = listSpu.stream().collect(Collectors.toMap(ProductSpuEntity::getId, spu -> spu));        // 查询sku规格        List<ProductSkuSpecEntity> listSkuSpec = productSkuSpecRepo.findListBySkuIds(skuIds);        Map<Long, List<ProductSkuSpecEntity>> mapSkuSpecs = listSkuSpec.stream().collect(Collectors.groupingBy(ProductSkuSpecEntity::getSkuId));        // 查询specs        Set<Long> specIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getSpecId).collect(Collectors.toSet());        Map<Long, ProductSpecDefEntity> mapSpecDef = productSpecDefRepo.findListByIds(specIds)                .stream().collect(Collectors.toMap(ProductSpecDefEntity::getId, v -> v));        // 查询opts        Set<Long> optIds = listSkuSpec.stream().map(ProductSkuSpecEntity::getOptId).collect(Collectors.toSet());        Map<Long, ProductSpecOptDefEntity> mapOptDef = productSpecOptDefRepo.findListByIds(optIds)                .stream().collect(Collectors.toMap(ProductSpecOptDefEntity::getId, v -> v));        return orderItems.stream().map(orderItem -> {            OrderShopProductVo vo = new OrderShopProductVo();            vo.setShopId(orderItem.getShopId());            Optional.ofNullable(mapShop.get(orderItem.getShopId())).ifPresent(shop -> vo.setShopName(shop.getShopName()));            vo.setSpuId(orderItem.getSpuId());            Optional.ofNullable(mapSpu.get(orderItem.getSpuId())).ifPresent(spu -> {                vo.setSpuName(spu.getName());                vo.setSpuMainImage(spu.getMainImage());            });            vo.setSkuId(orderItem.getSkuId());            vo.setSkuName(orderItem.getSkuName());            vo.setPrice(orderItem.getUnitPrice());            vo.setQuantity(orderItem.getQuantity());            // specs            List<ProductSkuSpecEntity> skuSpecs =                    mapSkuSpecs.getOrDefault(orderItem.getSkuId(), Collections.emptyList());            List<ProductSpecOptVo> listSpecOptVo = skuSpecs.stream().map(skuSpec -> {                ProductSpecOptVo optVo = new ProductSpecOptVo();                // set spec                Optional.ofNullable(mapSpecDef.get(skuSpec.getSpecId())).ifPresent(specDef -> {                    optVo.setSpecId(specDef.getId());                    optVo.setSpecName(specDef.getSpecName());                });                // set opt                Optional.ofNullable(mapOptDef.get(skuSpec.getOptId())).ifPresent(optDef -> {                    optVo.setOptId(optDef.getId());                    optVo.setOptName(optDef.getOptName());                });                // set sort                optVo.setSort(skuSpec.getSort());                return optVo;            }).collect(Collectors.toList());            vo.setSpecs(listSpecOptVo);            // 订单ID            vo.setOrderId(orderItem.getOrderId());            return vo;        }).collect(Collectors.toList());    }    /**     * 设置订单收货地址     */    private void setOrderReceiverAddress(OrderEntity order, MemberAddressEntity address) {        order.setReceiverName(address.getName());        order.setReceiverContact(address.getContact());        order.setReceiverProvinceCode(address.getProvinceCode());        order.setReceiverProvinceName(address.getProvinceName());        order.setReceiverCityCode(address.getCityCode());        order.setReceiverCityName(address.getCityName());        order.setReceiverDistrictCode(address.getDistrictCode());        order.setReceiverDistrictName(address.getDistrictName());        order.setReceiverDetailAddress(address.getDetailAddress());        order.setReceiverFullAddress(address.getFullAddress());        order.setReceiverPostalCode(address.getPostalCode());    }}