package com.yeshimin.yeahboot.app.service;import com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper;import com.yeshimin.yeahboot.common.utils.WxPayUtils;import com.yeshimin.yeahboot.data.common.enums.OrderStatusEnum;import com.yeshimin.yeahboot.data.domain.entity.OrderEntity;import com.yeshimin.yeahboot.data.repository.OrderRepo;import lombok.RequiredArgsConstructor;import lombok.extern.slf4j.Slf4j;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;/** * 订单状态流转相关服务 */@Slf4j@Service@RequiredArgsConstructorpublic class AppOrderStatusService {    private final OrderRepo orderRepo;    /**     * 处理支付成功     */    @Transactional(rollbackFor = Exception.class)    public boolean handlePaySuccess(WxPayUtils.Notification notification) {        String outTradeNo = notification.getOrderInfo().getOutTradeNo();        // 查询业务订单        OrderEntity order = orderRepo.findOneByOrderNo(outTradeNo);        // 如果业务订单不存在，返回成功，避免重复通知        if (order == null) {            log.warn("处理支付成功失败，订单不存在，outTradeNo={}", outTradeNo);            return true;        }        // 仅处理当前状态为【待付款】的情况，其他情况不做处理，返回成功        if (!OrderStatusEnum.WAIT_PAY.getValue().equals(order.getStatus())) {            log.info("处理支付成功失败，订单状态非待付款，outTradeNo={}, status={}", outTradeNo, order.getStatus());            return true;        }        // 更新订单状态        boolean success = orderRepo.updateStatus(order.getId(),                OrderStatusEnum.WAIT_PAY.getValue(), OrderStatusEnum.WAIT_SHIP.getValue());        // 可能已经处理过了，返回成功        if (!success) {            log.info("处理支付成功失败，订单状态更新失败，可能已经处理过了，outTradeNo={}", outTradeNo);            return true;        }        // 更新支付成功时间        LambdaUpdateWrapper<OrderEntity> updateWrapper = new LambdaUpdateWrapper<>();        updateWrapper.eq(OrderEntity::getId, order.getId())                .set(OrderEntity::getPaySuccessTime, notification.getOrderInfo().getSuccessTime().toLocalDateTime());        orderRepo.update(updateWrapper);        return true;    }}